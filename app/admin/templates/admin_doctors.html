<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='patient_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <title>Admin – Doctors</title>
</head>
<body>

<header class="navbar-admin">
    <div class="logo">
        <a href="{{ url_for('main.index') }}">CuraCloud</a>
    </div>
    <div class="nav-buttons">
        <div class="right-header">
            <div class="profile-icon">
                <img src="{{ url_for('static', filename='images/user.png') }}" alt="Admin Icon">
            </div>
            <a href="{{ url_for('auth.logout') }}">
                <button class="logout-btn">Logout</button>
            </a>
        </div>
    </div>
</header>

<div class="container">

    <!-- Sidebar -->
    <div class="side-menu">
        <ul>
            <li><a href="{{ url_for('admin.admin_home') }}">Home</a></li>
            <li><a href="{{ url_for('admin.admin_patients') }}">Patients</a></li>
            <li><a href="{{ url_for('admin.admin_doctors') }}" class="active">Doctors</a></li>
            <li><a href="{{ url_for('admin.admin_appointments') }}">Appointments</a></li>
            <li><a href="{{ url_for('admin.admin_billing') }}">Billing</a></li>
            <li><a href="{{ url_for('admin.system_logs') }}">System Logs</a></li>
        </ul>
    </div>

    <!--main-->
    <div class="content">

        <div class="welcome-section-admin">
            <div class="welcome-message">Doctor Directory</div>
            <div class="welcome-subtitle">View and manage all registered doctors.</div>
        </div>

        <!--add dr button-->
        <div class="add-patient-header">
            <button class="btn-primary-admin" id="openAddDoctorModal">+ Add Doctor</button>
        </div>

        <!--doctors table-->
        <div class="dashboard-container">
            <div class="dashboard-vertical">

                {% if doctors %}
                <div class="table-container">
                    <table class="billing-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="id">ID</th>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="specialty">Specialty</th>
                                <th class="sortable" data-sort="email">Email</th>
                                <th>Phone</th>
                                <th class="sortable" data-sort="patients">Patient Count</th>
                                <th class="sortable" data-sort="accepts">Accepting?</th>
                                <th>Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                        {% for doc in doctors %}
                        <tr>
                            <td>{{ doc.doctor_id }}</td>
                            <td>Dr. {{ doc.first_name }} {{ doc.last_name }}</td>
                            <td>{{ doc.specialty or "N/A" }}</td>
                            <td>{{ doc.email or "N/A" }}</td>
                            <td>{{ doc.phone_number or "N/A" }}</td>
                            <td>
                                <span class="patient-count-link"
                                    data-patients='[
                                        {% for p in doc.patients %}
                                            "{{ p.first_name|default('') }} {{ p.last_name|default('') }}"
                                            {% if not loop.last %},{% endif %}
                                        {% endfor %}
                                    ]'>
                                    {{ doc.patients|length }}
                                </span>
                            </td>
                            <td>
                                {{ "Yes" if doc.is_accepting_new_patients else "No" }}
                            </td>
                            <td class="action-cell">

                                <!--edit button-->
                                <button class="icon-btn edit-btn"
                                        title="Edit Doctor"
                                        data-id="{{ doc.doctor_id }}"
                                        data-first="{{ doc.first_name }}"
                                        data-last="{{ doc.last_name }}"
                                        data-email="{{ doc.email }}"
                                        data-phone="{{ doc.phone_number }}"
                                        data-specialty="{{ doc.specialty }}"
                                        data-city="{{ doc.city }}"
                                        data-state="{{ doc.state }}"
                                        data-accept="{{ doc.accepting_patients }}"
                                        data-patients="{{ doc.patients | map(attribute='patient_id') | list }}">
                                    <i class="fas fa-pen"></i>
                                </button>


                                <!--delete button-->
                                <form method="POST"
                                    action="{{ url_for('admin.delete_doctor', doctor_id=doc.doctor_id) }}"
                                    onsubmit="return confirm('Delete this doctor?');">

                                    <button type="submit" class="icon-btn delete-btn" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% else %}
                    <p>No doctors found.</p>
                {% endif %}

            </div>
        </div>
    </div>
</div>

<!--add dr modal-->
<div id="addDoctorModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Add Doctor</h3>
<div class="modal-header-line"></div>

        <form method="POST" action="{{ url_for('admin.add_doctor') }}">

            <input type="text" name="first_name" placeholder="First Name" required>
            <input type="text" name="last_name" placeholder="Last Name" required>

            <select name="specialty" required>
                <option value="">Select Specialty</option>
                {% for spec in specialties %}
                <option value="{{ spec }}">{{ spec }}</option>
                {% endfor %}
            </select>

            <input type="email" name="email" placeholder="Email" required>
            <input type="text" name="phone" placeholder="Phone">
            <input type="text" name="city" placeholder="City" required>
            <input type="text" name="state" placeholder="State" required>

            <div class="dropdown-checkbox">
                <button type="button" class="dropdown-btn">Assign Patients</button>

                <div class="dropdown-content patient-select-list">
                    {% for p in patients %}
                    <label>
                        <input type="checkbox" name="patient_ids" value="{{ p.patient_id }}">
                        {{ p.first_name }} {{ p.last_name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <label class="checkbox-label">
                <input type="checkbox" name="accepting_patients">
                Accepting New Patients
            </label>

            <div class="modal-buttons">
                <button type="submit" class="btn-primary-admin">Add Doctor</button>
                <button type="button" class="btn-secondary-admin" id="closeAddDoctorModal">Cancel</button>
            </div>

        </form>
    </div>
</div>

<!--edit dr modal-->
<div id="editDoctorModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Edit Doctor Information</h3>
<div class="modal-header-line"></div>

        <form id="editDoctorForm" method="POST">
            <input type="text" name="first_name" id="edit-first" required>
            <input type="text" name="last_name" id="edit-last" required>
            <input type="email" name="email" id="edit-email" required>
            <input type="text" name="phone" id="edit-phone">

            <select name="specialty" id="edit-specialty" required>
                {% for spec in specialties %}
                <option value="{{ spec }}">{{ spec }}</option>
                {% endfor %}
            </select>

            <input type="text" name="city" id="edit-city" required>
            <input type="text" name="state" id="edit-state" required>

            <div class="dropdown-checkbox">
                <button type="button" class="dropdown-btn" id="editPatientBtn">Assign Patients</button>

                <div class="dropdown-content patient-select-list" id="editPatientList">
                    {% for p in patients %}
                    <label>
                        <input type="checkbox"
                            class="edit-patient-checkbox"
                            value="{{ p.patient_id }}">
                        {{ p.first_name }} {{ p.last_name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <label class="checkbox-label">
                <input type="checkbox" name="accepting_patients" id="edit-accept">
                Accepting New Patients
            </label>

            <div class="modal-buttons">
                <button type="submit" class="btn-primary-admin">Save Changes</button>
                <button type="button" class="btn-secondary-admin" id="closeEditDoctorModal">Cancel</button>
            </div>
        </form>

    </div>
</div>

<!--patient name list-->
<div id="patientListModal" class="modal-overlay">
    <div class="modal-content" style="max-width:400px">
        <h3>Assigned Patients</h3>
        <div class="modal-header-line"></div>

        <ul id="patientListDisplay" style="padding-left:20px; line-height:1.8;"></ul>

        <div class="modal-buttons">
            <button class="btn-secondary-admin" id="closePatientList">Close</button>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const addModal = document.getElementById("addDoctorModal");
    const openAddBtn = document.getElementById("openAddDoctorModal");
    const closeAddBtn = document.getElementById("closeAddDoctorModal");

    openAddBtn.onclick = () => addModal.style.display = "flex";
    closeAddBtn.onclick = () => addModal.style.display = "none";

    const editModal = document.getElementById("editDoctorModal");
    const closeEditBtn = document.getElementById("closeEditDoctorModal");
    const editForm = document.getElementById("editDoctorForm");

    document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", () => {

            document.getElementById("edit-first").value = button.dataset.first;
            document.getElementById("edit-last").value = button.dataset.last;
            document.getElementById("edit-email").value = button.dataset.email;
            document.getElementById("edit-phone").value = button.dataset.phone;
            document.getElementById("edit-specialty").value = button.dataset.specialty;
            document.getElementById("edit-city").value = button.dataset.city;
            document.getElementById("edit-state").value = button.dataset.state;
            document.getElementById("edit-accept").checked =
                button.dataset.accept === "True" || button.dataset.accept === "1";

            editForm.action = `/edit_doctor/${button.dataset.id}`;
            const assigned = JSON.parse(button.dataset.patients.replace(/'/g, '"'));

            document.querySelectorAll("#editPatientList input[type='checkbox']")
                .forEach(cb => {
                    cb.checked = assigned.includes(Number(cb.value));
                });

            const editBtn = document.getElementById("editPatientBtn");

            if (assigned.length === 0) {
                editBtn.textContent = "Assign Patients";
            } else if (assigned.length === 1) {
                let label = document.querySelector(
                    `#editPatientList input[value='${assigned[0]}']`
                ).parentElement.innerText.trim();
                editBtn.textContent = label;
            } else {
                editBtn.textContent = `${assigned.length} patients selected`;
            }

            editModal.style.display = "flex";
        });
    });

    closeEditBtn.onclick = () => editModal.style.display = "none";

    window.onclick = (e) => {
        if (e.target === addModal) addModal.style.display = "none";
        if (e.target === editModal) editModal.style.display = "none";
    };
//sort
    document.querySelectorAll(".sortable").forEach(header => {
        header.addEventListener("click", () => {
            const table = header.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const sortType = header.dataset.sort;

            const newDirection = header.classList.contains("sort-asc") ? "desc" : "asc";

            document.querySelectorAll(".sortable")
                .forEach(h => h.classList.remove("sort-asc", "sort-desc"));

            header.classList.add(newDirection === "asc" ? "sort-asc" : "sort-desc");

            rows.sort((a, b) => {
                const A = a.children[header.cellIndex].innerText.trim();
                const B = b.children[header.cellIndex].innerText.trim();

                switch (sortType) {
                    case "id":
                        return newDirection === "asc"
                            ? Number(A) - Number(B)
                            : Number(B) - Number(A);
                    case "name":
                    case "specialty":
                    case "email":
                    case "phone":
                        return newDirection === "asc"
                            ? A.localeCompare(B)
                            : B.localeCompare(A);
                    case "patients":
                        return newDirection === "asc"
                            ? Number(A) - Number(B)
                            : Number(B) - Number(A);
                    case "accepts":
                        return newDirection === "asc"
                            ? A.localeCompare(B)
                            : B.localeCompare(A);
                }
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });

    document.querySelectorAll(".dropdown-checkbox").forEach(dropdown => {
        const btn = dropdown.querySelector(".dropdown-btn");
        const content = dropdown.querySelector(".dropdown-content");

        btn.addEventListener("click", (e) => {
            e.stopPropagation();
            document.querySelectorAll(".dropdown-content")
                .forEach(dc => { if (dc !== content) dc.style.display = "none"; });
            content.style.display = content.style.display === "block" ? "none" : "block";
        });

        document.addEventListener("click", (e) => {
            if (!content.contains(e.target) && e.target !== btn) {
                content.style.display = "none";
            }
        });

        content.addEventListener("change", () => {
            const checked = content.querySelectorAll("input[type='checkbox']:checked");
            if (checked.length === 0) btn.textContent = "Assign Patients";
            else if (checked.length === 1) btn.textContent = checked[0].parentElement.textContent.trim();
            else btn.textContent = `${checked.length} patients selected`;
        });
    });

});
document.querySelectorAll(".patient-count-link").forEach(item => {
    item.addEventListener("click", () => {

        const modal = document.getElementById("patientListModal");
        const list = document.getElementById("patientListDisplay");

        const names = JSON.parse(item.dataset.patients);

        list.innerHTML = names.length
            ? names.map(n => `<li>${n}</li>`).join("")
            : "<li>No assigned patients</li>";

        modal.style.display = "flex";
    });
});

document.getElementById("closePatientList").onclick = () =>
    document.getElementById("patientListModal").style.display = "none";

window.addEventListener("click", e => {
    const modal = document.getElementById("patientListModal");
    if (e.target === modal) modal.style.display = "none";
});
</script>


<div class="footer">
    <div>© Powered by Coin Flippers</div>
</div>

</body>
</html>
